name: OpenAPI Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer
          coverage: none

      - name: Setup Node (optional; keep if you ever switch driver to npx)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Start WAHA (latest)
        run: |
          docker run -d --name waha -p 3000:3000 \
            -e "WHATSAPP_SWAGGER_USERNAME=${{ secrets.WAHA_SWAGGER_USERNAME }}" \
            -e "WHATSAPP_SWAGGER_PASSWORD=${{ secrets.WAHA_SWAGGER_PASSWORD }}" \
            devlikeapro/waha:latest

      - name: Wait for WAHA (-json reachable)
        env:
          SWAGGER_USER: ${{ secrets.WAHA_SWAGGER_USERNAME }}
          SWAGGER_PASS: ${{ secrets.WAHA_SWAGGER_PASSWORD }}
        run: |
          set -e

          # Build curl auth args only if both secrets are provided.
          CURL_AUTH_ARGS=""
          if [ -n "$SWAGGER_USER" ] && [ -n "$SWAGGER_PASS" ]; then
            CURL_AUTH_ARGS="-u ${SWAGGER_USER}:${SWAGGER_PASS}"
          fi

          # Wait until /-json returns HTTP 200.
          # We tolerate connection resets and 401 while the service is starting / credentials mismatch.
          for i in {1..90}; do
            code=$(curl -sS -o /dev/null -w "%{http_code}" $CURL_AUTH_ARGS "http://localhost:3000/-json" || true)

            if [ "$code" = "200" ]; then
              echo "WAHA is ready (/-json -> 200)"
              exit 0
            fi

            echo "Waiting for WAHA... attempt=$i http_code=$code"
            sleep 2
          done

          echo "WAHA did not become ready in time"
          docker logs waha --tail 200
          exit 1

      - name: Fetch OpenAPI spec from WAHA (-json) into repo file
        env:
          SWAGGER_USER: ${{ secrets.WAHA_SWAGGER_USERNAME }}
          SWAGGER_PASS: ${{ secrets.WAHA_SWAGGER_PASSWORD }}
        run: |
          set -e
          mkdir -p resources/openapi

          CURL_AUTH_ARGS=""
          if [ -n "$SWAGGER_USER" ] && [ -n "$SWAGGER_PASS" ]; then
            CURL_AUTH_ARGS="-u ${SWAGGER_USER}:${SWAGGER_PASS}"
          fi

          # Retry fetch to avoid transient "connection reset by peer".
          for i in {1..10}; do
            if curl -fsS $CURL_AUTH_ARGS "http://localhost:3000/-json" -o "resources/openapi/openapi.json"; then
              echo "Fetched spec successfully"
              exit 0
            fi

            echo "Fetch failed, retrying... attempt=$i"
            sleep 2
          done

          echo "Failed to fetch spec after retries"
          docker logs waha --tail 200
          exit 1

      - name: Run OpenAPI sync (generate + ide-helper if changed)
        env:
          # Source is local file (your openapi-sync.php supports local paths after your change)
          WAHA_OPENAPI_URL: "resources/openapi/openapi.json"

          # Canonical spec path in repo
          WAHA_SPEC_PATH: "resources/openapi/openapi.json"
          WAHA_GENERATED_PATH: "src/Generated"

          # Deterministic generator
          WAHA_OPENAPI_GENERATOR_DRIVER: "docker"
          WAHA_OPENAPI_GENERATOR_IMAGE: "openapitools/openapi-generator-cli:v7.6.0"

          WAHA_OPENAPI_TIMEOUT: "30"
          WAHA_OPENAPI_GENERATOR_TIMEOUT: "300"
        run: php bin/openapi-sync.php

      - name: Run Pint (fix)
        run: |
          set -e
          if [ -x "vendor/bin/pint" ]; then
            vendor/bin/pint
          else
            echo "Pint not found at vendor/bin/pint. Make sure laravel/pint is installed."
            exit 1
          fi

      - name: Stop WAHA
        if: always()
        run: |
          docker rm -f waha || true

      - name: Check git diff
        id: diff
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(openapi): sync spec + regenerate client"
          branch: "bot/openapi-sync"
          delete-branch: true
          title: "chore(openapi): sync spec + regenerate client"
          body: |
            Automated update:
            - fetched OpenAPI spec from running WAHA instance (/ -json)
            - regenerated client
            - regenerated IDE helper
            - applied Pint fixes
          labels: |
            openapi
            automation
          base: main